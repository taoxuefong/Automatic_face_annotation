# 批量人脸检测脚本使用说明

## 功能描述

这个脚本使用YOLOv9模型对数据集中的图片进行人脸检测，并将检测到的人脸坐标添加到对应的标签文件中。

## 数据集结构要求

数据集应该按照以下结构组织：
```
/data/txf/1/data/
├── train/
│   ├── images/          # 训练图片
│   └── labels/          # 训练标签
├── test/
│   ├── images/          # 测试图片
│   └── labels/          # 测试标签
└── valid/
    ├── images/          # 验证图片
    └── labels/          # 验证标签
```

## 标签文件格式

- 每个图片对应一个同名的.txt标签文件
- 每行格式：`类别 x_center y_center width height`
- 坐标值已归一化到0-1范围
- 人脸类别编号为5

## 使用方法

### 基本用法
```bash
python batch_face_detection.py
```

### 自定义参数
```bash
python batch_face_detection.py \
    --data-dir /data/txf/1/data \
    --weights /data/txf/1/yolov9-face-detection-main/yolov9/yolov9.pt \
    --conf-threshold 0.25 \
    --device 0
```

### 参数说明

- `--data-dir`: 数据集根目录路径（默认：/data/txf/1/data）
- `--weights`: YOLOv9模型权重文件路径（默认：/data/txf/1/yolov9-face-detection-main/yolov9/yolov9.pt）
- `--conf-threshold`: 置信度阈值（默认：0.25）
- `--device`: 设备选择，支持cpu或GPU编号（默认：自动选择）

## 处理流程

1. **模型加载**: 加载指定的YOLOv9权重文件
2. **图片处理**: 遍历train、test、valid三个目录中的images文件夹
3. **人脸检测**: 对每张图片进行人脸检测
4. **坐标转换**: 将检测到的xyxy坐标转换为YOLO格式
5. **标签更新**: 将新检测到的人脸（类别5）添加到对应的标签文件中
6. **保留原有标签**: 脚本会保留标签文件中的原有内容，只添加新的人脸标签

## 注意事项

1. 确保YOLOv9模型权重文件存在且可访问
2. 确保数据集目录结构正确
3. 脚本会保留原有的标签内容，只添加新的人脸检测结果
4. 如果标签文件不存在，会创建新的标签文件
5. 支持的图片格式：jpg, jpeg, png, bmp

## 输出示例

处理过程中会显示类似以下信息：
```
批量人脸检测脚本
数据集目录: /data/txf/1/data
模型权重: /data/txf/1/yolov9-face-detection-main/yolov9/yolov9.pt
置信度阈值: 0.25
设备: 自动选择

正在加载模型: /data/txf/1/yolov9-face-detection-main/yolov9/yolov9.pt
模型加载完成

处理 train 数据集...
处理图片: 1_104_jpg.rf.eaf8b93705c7f82b8cf16816ec7810b4.jpg (1/100)
  检测到 2 个人脸，已添加到标签文件

处理 test 数据集...
处理图片: test_image.jpg (1/50)
  未检测到人脸

完成处理 train 数据集，共处理 100/100 张图片
完成处理 test 数据集，共处理 50/50 张图片
完成处理 valid 数据集，共处理 30/30 张图片

批量人脸检测完成！
```

## 错误处理

脚本包含完善的错误处理机制：
- 检查数据集目录和模型文件是否存在
- 处理无法读取的图片文件
- 处理推理过程中的异常
- 提供详细的处理进度和错误信息 