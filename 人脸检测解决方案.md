# YOLOv9 人脸检测解决方案

## 问题描述

您有一个目标检测数据集，包含train、test、valid三个目录，每个目录都有images和labels子文件夹。您希望使用YOLOv9模型对数据集中的所有图片进行人脸检测，并将检测到的人脸坐标添加到对应的标签文件中，人脸类别编号为5。

## 解决方案

我为您创建了一个完整的批量人脸检测解决方案，包含以下文件：

### 1. 核心脚本文件

#### `batch_face_detection.py`
- **功能**: 主要的批量人脸检测脚本
- **特点**: 
  - 支持自定义模型权重文件路径
  - 自动处理train、test、valid三个数据集
  - 保留原有标签内容，只添加新的人脸标签
  - 完善的错误处理和进度显示
  - 支持GPU加速

#### `test_face_detection.py`
- **功能**: 功能测试脚本
- **特点**:
  - 测试模块导入是否正常
  - 测试模型加载是否成功
  - 检查数据集目录结构
  - 统计图片和标签文件数量

### 2. 运行脚本

#### `run_face_detection.sh`
- **功能**: 一键运行脚本
- **特点**:
  - 自动检查环境依赖
  - 运行功能测试
  - 交互式确认
  - 自动执行批量检测

### 3. 文档文件

#### `批量人脸检测使用说明.md`
- 详细的使用说明和参数介绍

#### `人脸检测解决方案.md`
- 本文件，完整的解决方案说明

## 数据集结构

您的数据集应该按照以下结构组织：
```
/data/txf/1/data/
├── train/
│   ├── images/          # 训练图片
│   └── labels/          # 训练标签
├── test/
│   ├── images/          # 测试图片
│   └── labels/          # 测试标签
└── valid/
    ├── images/          # 验证图片
    └── labels/          # 验证标签
```

## 标签文件格式

- 每个图片对应一个同名的.txt标签文件
- 每行格式：`类别 x_center y_center width height`
- 坐标值已归一化到0-1范围
- 人脸类别编号为5

### 示例标签文件内容
```
1 0.736979 0.074847 0.072917 0.103394
3 0.707898 0.170523 0.127604 0.285495
5 0.500000 0.300000 0.100000 0.150000  # 新添加的人脸标签
```

## 使用方法

### 方法1: 使用一键运行脚本（推荐）
```bash
./run_face_detection.sh
```

### 方法2: 直接运行Python脚本
```bash
# 基本用法
python3 batch_face_detection.py

# 自定义参数
python3 batch_face_detection.py \
    --data-dir /data/txf/1/data \
    --weights /data/txf/1/yolov9-face-detection-main/yolov9/yolov9.pt \
    --conf-threshold 0.25 \
    --device 0
```

### 方法3: 先测试再运行
```bash
# 运行测试
python3 test_face_detection.py

# 如果测试通过，运行检测
python3 batch_face_detection.py
```

## 参数说明

- `--data-dir`: 数据集根目录路径（默认：/data/txf/1/data）
- `--weights`: YOLOv9模型权重文件路径（默认：/data/txf/1/yolov9-face-detection-main/yolov9/yolov9.pt）
- `--conf-threshold`: 置信度阈值（默认：0.25）
- `--device`: 设备选择，支持cpu或GPU编号（默认：自动选择）

## 处理流程

1. **环境检查**: 检查Python环境和必要文件
2. **模型加载**: 加载指定的YOLOv9权重文件
3. **数据集遍历**: 依次处理train、test、valid三个数据集
4. **图片处理**: 对每张图片进行人脸检测
5. **坐标转换**: 将检测到的xyxy坐标转换为YOLO格式
6. **标签更新**: 将新检测到的人脸（类别5）添加到对应的标签文件中
7. **进度显示**: 实时显示处理进度和结果

## 技术特点

### 1. 高效处理
- 使用YOLOv9模型进行快速人脸检测
- 支持GPU加速
- 批量处理，减少模型加载时间

### 2. 数据安全
- 保留原有标签内容
- 只添加新的人脸检测结果
- 完善的错误处理机制

### 3. 灵活配置
- 支持自定义置信度阈值
- 支持设备选择（CPU/GPU）
- 支持自定义模型权重文件

### 4. 用户友好
- 详细的进度显示
- 清晰的错误信息
- 完整的测试功能

## 输出示例

运行过程中会显示类似以下信息：
```
批量人脸检测脚本
数据集目录: /data/txf/1/data
模型权重: /data/txf/1/yolov9-face-detection-main/yolov9/yolov9.pt
置信度阈值: 0.25
设备: 自动选择

正在加载模型: /data/txf/1/yolov9-face-detection-main/yolov9/yolov9.pt
模型加载完成

处理 train 数据集...
处理图片: 1_104_jpg.rf.eaf8b93705c7f82b8cf16816ec7810b4.jpg (1/100)
  检测到 2 个人脸，已添加到标签文件

处理 test 数据集...
处理图片: test_image.jpg (1/50)
  未检测到人脸

完成处理 train 数据集，共处理 100/100 张图片
完成处理 test 数据集，共处理 50/50 张图片
完成处理 valid 数据集，共处理 30/30 张图片

批量人脸检测完成！
```

## 注意事项

1. **模型文件**: 确保YOLOv9模型权重文件存在且可访问
2. **数据集结构**: 确保数据集目录结构正确
3. **存储空间**: 确保有足够的存储空间保存更新后的标签文件
4. **处理时间**: 根据图片数量和硬件配置，处理时间可能较长
5. **备份数据**: 建议在处理前备份原始数据集

## 故障排除

### 常见问题

1. **模型加载失败**
   - 检查模型文件路径是否正确
   - 检查模型文件是否完整

2. **导入错误**
   - 确保YOLOv9依赖已正确安装
   - 检查Python路径设置

3. **数据集目录不存在**
   - 检查数据集路径是否正确
   - 确保目录结构符合要求

4. **内存不足**
   - 降低批处理大小
   - 使用CPU模式
   - 关闭其他占用内存的程序

## 扩展功能

如果需要进一步的功能扩展，可以考虑：

1. **多类别检测**: 支持检测其他类别的人脸相关目标
2. **批量处理优化**: 使用多进程或多线程加速处理
3. **可视化结果**: 生成检测结果的可视化图片
4. **结果统计**: 统计检测结果的分布情况
5. **质量控制**: 添加检测质量评估功能

这个解决方案为您提供了一个完整、高效、安全的批量人脸检测工具，可以满足您的需求。 