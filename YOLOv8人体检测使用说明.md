# YOLOv8 批量人体检测使用说明

## 功能描述

这个脚本使用YOLOv8模型对数据集中的图片进行人体检测，**删除原有类别3的标签**，并将新检测到的人体坐标添加到对应的标签文件中。

## 重要特性

### ⚠️ 关键功能
- **删除原有类别3标签**：脚本会删除所有标签文件中类别3（人体）的原有坐标
- **添加新检测结果**：将YOLOv8检测到的人体坐标作为新的类别3标签添加
- **保留其他类别**：其他类别的标签（0,1,2,4,5等）会被保留

### 🔄 处理流程
1. 读取现有标签文件
2. **删除所有类别3的标签**
3. 使用YOLOv8检测人体
4. 将新检测到的人体坐标转换为YOLO格式
5. 添加新的类别3标签
6. 保存更新后的标签文件

## 数据集结构要求

数据集应该按照以下结构组织：
```
/data/txf/1/data/
├── train/
│   ├── images/          # 训练图片
│   └── labels/          # 训练标签
├── test/
│   ├── images/          # 测试图片
│   └── labels/          # 测试标签
└── valid/
    ├── images/          # 验证图片
    └── labels/          # 验证标签
```

## 标签文件格式

### 原始标签文件示例
```
1 0.736979 0.074847 0.072917 0.103394
3 0.707898 0.170523 0.127604 0.285495  # 原有的人体标签（将被删除）
1 0.767794 0.384259 0.059896 0.157407
3 0.805990 0.310185 0.139758 0.342593  # 原有的人体标签（将被删除）
0 0.266927 0.715278 0.051216 0.121912
```

### 处理后标签文件示例
```
1 0.736979 0.074847 0.072917 0.103394
1 0.767794 0.384259 0.059896 0.157407
0 0.266927 0.715278 0.051216 0.121912
3 0.500000 0.300000 0.100000 0.150000  # 新检测的人体标签
3 0.700000 0.400000 0.120000 0.180000  # 新检测的人体标签
```

## 使用方法

### 方法1: 使用一键运行脚本（推荐）
```bash
chmod +x run_person_detection.sh
./run_person_detection.sh
```

### 方法2: 直接运行Python脚本
```bash
# 基本用法
python3 batch_person_detection.py

# 自定义参数
python3 batch_person_detection.py \
    --data-dir /data/txf/1/data \
    --weights yolov8-detect/best.pt \
    --conf-threshold 0.5
```

### 方法3: 先测试再运行
```bash
# 运行测试
python3 test_person_detection.py

# 如果测试通过，运行检测
python3 batch_person_detection.py
```

## 参数说明

- `--data-dir`: 数据集根目录路径（默认：/data/txf/1/data）
- `--weights`: YOLOv8模型权重文件路径（默认：yolov8-detect/best.pt）
- `--conf-threshold`: 置信度阈值（默认：0.5）

## 安全确认

由于此操作会**删除所有原有类别3的标签**，脚本会在运行前要求确认：

```
警告: 此操作将删除所有原有类别3的标签，并替换为新检测的人体坐标
是否继续？(y/N): 
```

输入 `y` 确认继续，输入其他任何内容取消操作。

## 输出示例

处理过程中会显示类似以下信息：
```
批量人体检测脚本
数据集目录: /data/txf/1/data
模型权重: yolov8-detect/best.pt
置信度阈值: 0.5
注意: 将删除原有类别3标签，并添加新检测的人体坐标

警告: 此操作将删除所有原有类别3的标签，并替换为新检测的人体坐标
是否继续？(y/N): y

正在加载YOLOv8模型: yolov8-detect/best.pt
模型加载完成

处理 train 数据集...
处理图片: 1_104_jpg.rf.eaf8b93705c7f82b8cf16816ec7810b4.jpg (1/100)
  删除了 2 个原有的人体标签
  检测到 3 个人体，已添加到标签文件

处理 test 数据集...
处理图片: test_image.jpg (1/50)
  未检测到人体

完成处理 train 数据集，共处理 100/100 张图片
完成处理 test 数据集，共处理 50/50 张图片
完成处理 valid 数据集，共处理 30/30 张图片

批量人体检测完成！
```

## 注意事项

### ⚠️ 重要警告
1. **数据备份**：建议在处理前备份原始数据集
2. **不可逆操作**：删除的类别3标签无法恢复
3. **确认操作**：脚本会要求确认后才执行删除操作

### 技术细节
1. **模型要求**：需要YOLOv8模型文件（best.pt）
2. **依赖库**：需要安装ultralytics、opencv-python、numpy
3. **内存使用**：根据图片数量和大小，可能需要较多内存
4. **处理时间**：根据图片数量和硬件配置，处理时间可能较长

### 类别映射
- **YOLOv8检测结果**：假设人体是类别0（根据实际模型调整）
- **输出标签**：统一转换为类别3
- **其他类别**：保持不变（0,1,2,4,5等）

## 故障排除

### 常见问题

1. **模型加载失败**
   - 检查模型文件路径是否正确
   - 确保模型文件完整且可访问

2. **导入错误**
   - 安装ultralytics：`pip install ultralytics`
   - 安装opencv：`pip install opencv-python`

3. **检测结果为空**
   - 调整置信度阈值（--conf-threshold）
   - 检查模型是否针对人体检测进行了训练

4. **内存不足**
   - 减少批处理大小
   - 关闭其他占用内存的程序

### 调试建议

1. **先运行测试**：使用 `test_person_detection.py` 验证环境
2. **小批量测试**：先用少量图片测试
3. **检查输出**：观察删除和添加的标签数量是否合理

## 扩展功能

如果需要进一步的功能扩展，可以考虑：

1. **类别映射配置**：支持自定义类别映射关系
2. **备份功能**：自动备份原始标签文件
3. **可视化结果**：生成检测结果的可视化图片
4. **批量处理优化**：使用多进程加速处理
5. **质量控制**：添加检测质量评估功能

这个解决方案为您提供了一个安全、高效的批量人体检测工具，能够准确替换原有的人体标签。 